# Python金融项目

这是一个使用Python进行金融数据分析和交易策略回测的项目。它为量化交易研究提供了一个全面的框架，允许用户使用历史市场数据来实现、测试和可视化交易策略。

## 核心概念

该项目围绕几个关键组件构建，这些组件协同工作以促进量化交易研究：

- **数据管理**：高效地从各种来源加载和预处理金融数据
- **策略开发**：实现自定义交易策略的框架
- **回测引擎**：针对历史数据测试策略的稳健系统
- **风险管理**：评估策略表现和风险指标的工具
- **可视化**：用于分析结果的全面制图功能

### 回测引擎

回测引擎负责根据策略信号模拟交易并计算表现指标。其工作原理如下：

1. 从策略生成交易信号
2. 在收盘价执行交易（防止前瞻偏差）
3. 跟踪仓位变化和现金流
4. 计算表现指标

**交易执行：**
- 买入信号：使用所有可用现金购买股票（四舍五入到整股）
- 卖出信号：卖出所有持仓
- 交易在信号日的收盘价执行

**表现指标：**
- 总收益：$总收益(\%) = \frac{最终价值 - 初始资本}{初始资本} \times 100\%$
- 胜率：$胜率(\%) = \frac{盈利交易}{总交易数} \times 100\%$
- 最大回撤：$最大回撤(\%) = \max(\frac{峰值 - 谷值}{峰值}) \times 100\%$

这种方法提供了策略在实盘交易中表现的现实模拟，同时考虑了交易成本（通过整股四舍五入）和市场影响（通过使用收盘价）等因素。

## 项目结构

- `data_loader.py`：负责从各种来源导入和预处理金融数据的数据加载模块
- `strategies/`：包含模块化策略类的交易策略实现目录
- `backtester.py`：针对历史数据执行策略并计算表现指标的回测引擎
- `visualizer.py`：用于绘制价格图表、策略信号和表现指标的可视化工具
- `main.py`：配置和运行分析管道的主程序入口点
- `sample_test_01.ipynb`：演示项目使用和功能的示例Jupyter Notebook
- `config.yaml`：用于设置数据源、策略参数和执行选项的配置文件

## 要求

- Python 3.8+
- [uv](https://github.com/astral-sh/uv) - 一个极快的Python包安装程序和解析器
- 相关依赖项（参见`pyproject.toml`）

## 安装

1. 在本地克隆仓库：
   ```
   git clone <repository-url>
   ```

2. 导航到项目目录：
   ```
   cd python_finance
   ```

3. 使用uv安装依赖项：
   ```
   uv sync
   ```
   这将自动创建和管理虚拟环境，并从`pyproject.toml`安装所有依赖项。

## 使用

在运行任何命令之前，激活uv创建的虚拟环境：

```
uv run
```

### 运行主程序

```
uv run python main.py
```

### 运行Jupyter Notebook

```
uv run jupyter notebook sample_test_01.ipynb
```

### 运行回测

在`main.py`中配置参数后，运行：

```
uv run python main.py --mode=backtest
```

## 配置

项目配置在`config.yaml`文件中，您可以在其中配置数据源、交易策略参数等。

数据加载配置在`data_loader.yml`文件中，您可以在其中配置CSV文件路径和列名。这使得项目更容易适应不同的数据源，而无需修改代码。

## 策略开发

该项目为开发自定义交易策略提供了灵活的框架。每个策略都在`strategies/`目录中作为一个单独的类实现，遵循一致的接口，允许与回测引擎无缝集成。

创建新策略的步骤：
1. 在`strategies/`目录中创建一个新的Python文件
2. 实现一个继承自基础策略接口的类
3. 在所需方法中定义您的交易逻辑
4. 在`main.py`中注册策略，使其可用于回测

策略可以结合各种技术指标、风险管理和仓位规模算法，以适应不同的交易方法。

### 实现的策略

该项目包含几种预实现的交易策略，每种策略都基于不同的技术分析原理：

#### 1. 移动平均策略

移动平均策略基于移动平均线交叉生成交易信号。它使用两个不同周期的移动平均线：
- 短期移动平均线（MA_short）
- 长期移动平均线（MA_long）

**原理：**
- 买入信号：当MA_short上穿MA_long（金叉）
- 卖出信号：当MA_short下穿MA_long（死叉）

**计算公式：**
- $MA_t(n) = \frac{1}{n} \sum_{i=0}^{n-1} P_{t-i}$

其中：
- $MA_t(n)$是时间t的n周期移动平均线
- $P_{t-i}$是时间t-i的收盘价

**优点：**
- 简单直观
- 在趋势市场中表现良好
- 对短期价格波动不太敏感

**缺点：**
- 滞后指标
- 在横盘市场中可能产生错误信号
- 需要参数调整

#### 2. RSI策略

RSI（相对强弱指数）策略基于超买和超卖条件生成信号：

**原理：**
- 买入信号：当RSI上穿超卖水平（通常为30）
- 卖出信号：当RSI下穿超买水平（通常为70）

**计算公式：**
- $RSI = 100 - \frac{100}{1 + RS}$
- $RS = \frac{\text{n周期平均收益}}{\text{n周期平均损失}}$

其中：
- RS是相对强度
- 收益是正的价格变化
- 损失是负的价格变化的绝对值

**优点：**
- 善于识别超买/超卖条件
- 在均值回归市场中表现良好
- 可以识别潜在的反转点

**缺点：**
- 在强劲趋势期间可能保持在超买/超卖区域
- 可能产生错误信号
- 需要仔细的参数调整

#### 3. MACD策略

MACD（异同移动平均线）策略基于MACD线和信号线之间的关系生成信号：

**原理：**
- 买入信号：当MACD线上穿信号线
- 卖出信号：当MACD线下穿信号线

**计算公式：**
- $EMA_{fast} = EMA(\text{收盘价}, n_{fast})$
- $EMA_{slow} = EMA(\text{收盘价}, n_{slow})$
- $MACD_{line} = EMA_{fast} - EMA_{slow}$
- $Signal_{line} = EMA(MACD_{line}, n_{signal})$
- $Histogram = MACD_{line} - Signal_{line}$

其中：
- $EMA$是指数移动平均线
- $n_{fast}$、$n_{slow}$、$n_{signal}$分别是快速EMA、慢速EMA和信号线的周期

**优点：**
- 结合了趋势跟踪和动量指标
- 可以识别市场动量的变化
- 在趋势市场中表现良好

**缺点：**
- 在横盘市场中可能产生错误信号
- 由于移动平均线而成为滞后指标
- 需要参数调整

#### 4. 线性回归策略

线性回归策略使用线性回归基于历史数据预测未来价格走势：

**原理：**
- 使用历史收盘价作为特征
- 训练线性回归模型以预测未来价格变化
- 当预测变化为正时生成买入信号
- 当预测变化为负时生成卖出信号

**计算公式：**
- $y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + ... + \beta_n x_n + \epsilon$

其中：
- $y$是预测的价格变化
- $x_i$是滞后收盘价（特征）
- $\beta_i$是回归系数
- $\epsilon$是误差项

**优点：**
- 可以捕捉数据中的复杂模式
- 适应不断变化的市场条件
- 基于数据的客观决策

**缺点：**
- 需要足够的历史数据进行训练
- 可能对历史数据过拟合
- 黑箱性质使其难以解释
- 需要机器学习专业知识

该策略展示了如何将机器学习技术应用于金融市场进行预测建模。

#### 5. 多项式回归策略

多项式回归策略通过使用多项式特征来捕捉数据中的非线性关系，扩展了线性回归方法：

**原理：**
- 使用历史收盘价作为基础特征
- 将特征转换为多项式项以建模非线性模式
- 训练多项式回归模型以预测未来价格变化
- 当预测变化为正时生成买入信号
- 当预测变化为负时生成卖出信号

**计算公式：**
- $y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + ... + \beta_n x_n + \beta_{n+1} x_1^2 + \beta_{n+2} x_1x_2 + ... + \beta_m x_n^2 + \epsilon$

其中：
- $y$是预测的价格变化
- $x_i$是滞后收盘价（特征）
- $\beta_i$是回归系数
- $\epsilon$是误差项

**优点：**
- 可以捕捉数据中的非线性模式
- 比线性回归更灵活
- 适应不断变化的市场条件
- 基于数据的客观决策

**缺点：**
- 需要足够的历史数据进行训练
- 可能对历史数据过拟合，特别是使用高次多项式时
- 黑箱性质使其难以解释
- 需要机器学习和参数调整的专业知识

该策略展示了如何使用多项式回归来建模金融数据中更复杂的关系。

#### 6. 随机森林策略

随机森林策略使用决策树集来基于历史数据预测未来价格走势：

**原理：**
- 使用历史收盘价作为特征
- 训练随机森林回归模型以预测未来价格变化
- 当预测变化为正时生成买入信号
- 当预测变化为负时生成卖出信号
- 使用交叉验证来评估模型性能并防止过拟合

**计算公式：**
- $y = \frac{1}{n} \sum_{i=1}^{n} T_i(x)$

其中：
- $y$是预测的价格变化
- $T_i$是第$i$棵树的预测
- $x$是滞后收盘价（特征）
- $n$是森林中树的数量

**优点：**
- 可以捕捉数据中的复杂非线性模式
- 与单个决策树相比，不太容易过拟合
- 能够很好地处理异常值
- 提供特征重要性排名
- 适应不断变化的市场条件
- 基于数据的客观决策
- 使用交叉验证确保模型泛化能力

**缺点：**
- 需要足够的历史数据进行训练
- 黑箱性质使其难以解释
- 需要机器学习和参数调整的专业知识
- 计算成本比线性模型高

该策略展示了如何将集成方法应用于金融市场进行预测建模。实现中包含了交叉验证来评估模型性能，确保对未见数据有更好的泛化能力。

### 策略比较

在选择交易策略时，重要的是要考虑市场条件和您的交易目标：

1. **移动平均策略**：最适合出现明确方向性走势的趋势市场。
2. **RSI策略**：在价格倾向于回到平均水平的均值回归市场中最有效。
3. **MACD策略**：有助于识别市场动量的变化，在趋势市场中表现良好。
4. **线性回归策略**：具有捕捉复杂模式的潜力，但需要仔细验证以避免过拟合。
5. **多项式回归策略**：可以捕捉数据中的非线性关系，使其适用于更复杂的市场动态，但需要仔细调整参数以防止过拟合。
6. **随机森林策略**：通过组合多个决策树提供稳健的预测，降低过拟合风险，但需要仔细的参数调整且计算成本较高。

在实践中，结合多种策略或在不同市场条件下使用不同策略通常比依赖单一方法产生更好的结果。项目的模块化设计使得可以轻松试验不同的组合，并通过回测评估其表现。

#### 回测结果摘要

下表总结了每个已实现策略的回测结果：

| 策略名称 | 总收益率(%) | 交易次数 | 胜率(%) | 最大回撤(%) |
|----------|------------|---------|--------|------------|
| 移动平均策略 | -11.98 | 318 | 35.85 | -41.54 |
| RSI策略 | -31.0 | 209 | 42.55 | -34.77 |
| MACD策略 | -14.53 | 1163 | 39.02 | -38.33 |
| 线性回归策略 | 35.65 | 1388 | 74.2 | -13.13 |
| 多项式回归策略 | N/A | N/A | N/A | N/A |
| 随机森林策略 | N/A | N/A | N/A | N/A |

注：多项式回归策略的结果尚不可用，因为它是一个新实现的策略。鼓励用户运行自己的回测来评估其表现。

## 数据

该项目通过`data_loader.py`模块支持灵活的数据管理，可以处理各种金融数据格式和来源。

- **支持的格式**：具有标准OHLCV（开盘价、最高价、最低价、收盘价、成交量）格式的CSV文件
- **数据位置**：项目数据存储在`stock_data/`目录中
- **可扩展性**：数据加载系统可以扩展以支持其他数据源，如数据库或实时数据

数据加载器提供预处理功能，包括：
- 数据清理和验证
- 时区处理和日期对齐
- 重新采样到不同时框
- 技术指标计算

这种模块化的方法使研究人员能够专注于策略开发，而不是数据管理的复杂性。

### 技术指标计算

项目的数据加载器和策略模块协同工作，计算实现策略中使用的技术指标：

1. **移动平均线**
   - 简单移动平均线（SMA）：$MA_t(n) = \frac{1}{n} \sum_{i=0}^{n-1} P_{t-i}$
   - 指数移动平均线（EMA）：$EMA_t = \alpha \times P_t + (1 - \alpha) \times EMA_{t-1}$，其中$\alpha = \frac{2}{n+1}$

2. **RSI（相对强弱指数）**
   - 收益计算：$Gain_t = \max(0, P_t - P_{t-1})$
   - 损失计算：$Loss_t = \max(0, P_{t-1} - P_t)$
   - 平均收益：$AvgGain_t = \frac{\sum_{i=1}^{n} Gain_{t-i+1}}{n}$
   - 平均损失：$AvgLoss_t = \frac{\sum_{i=1}^{n} Loss_{t-i+1}}{n}$
   - RSI：$RSI = 100 - \frac{100}{1 + \frac{AvgGain}{AvgLoss}}$

3. **MACD（异同移动平均线）**
   - 快速EMA：$EMA_{fast,t} = EMA(\text{收盘价}, n_{fast})$
   - 慢速EMA：$EMA_{slow,t} = EMA(\text{收盘价}, n_{slow})$
   - MACD线：$MACD_{line,t} = EMA_{fast,t} - EMA_{slow,t}$
   - 信号线：$Signal_{line,t} = EMA(MACD_{line}, n_{signal})$
   - 柱状图：$Histogram_t = MACD_{line,t} - Signal_{line,t}$

使用相应策略时，这些计算会自动执行，确保一致且准确的技术分析。

## 许可证

该项目基于MIT许可证 - 详见[LICENSE](LICENSE)文件。